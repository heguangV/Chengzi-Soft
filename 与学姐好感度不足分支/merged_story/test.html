<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‰§æƒ…é¡µé¢ - åˆå¹¶ç‰ˆ</title>
  <style>
    /* æ ·å¼ä¿æŒä¸å˜ï¼Œä¸ä¹‹å‰ç›¸åŒ */
    * {
      box-sizing: border-box;
    }
    body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      overflow: hidden;
      transition: opacity 1s ease;
      opacity: 0;
      background: url('images/background.png') no-repeat center center fixed;
      background-size: cover;
      font-family: "å¾®è½¯é›…é»‘", sans-serif;
    }

    /* é¡µé¢åŠ è½½åè‡ªåŠ¨åŠ ä¸Š fade-in */
    body.fade-in {
      opacity: 1;
    }

    /* é¡µé¢ç¦»å¼€æ—¶ç”¨ fade-out */
    body.fade-out {
      opacity: 0;
    }

  .background-img,
.character-img {
  max-width: 100%;
}

    /* å¯¹è¯æ¡† */
    .dialog-box {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100vw;
      height: 22vw;
      max-width: 100%;
      color: #fff;
      padding: 1em 2em;
      box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.3);
      border-radius: 0;
      box-sizing: border-box;
      z-index: 2;
    }

    /* è§’è‰²å */
    .character-name {
      font-weight: bold;
      margin-bottom: 0.5em;
      font-size: 0.9em;
      margin-left: 5%;
      margin-top: 0.5%;
    }

    /* å¯¹è¯æ–‡å­— */
    .dialog-text {
      position: absolute;
      top: 50%;
      left: 10%;
      transform: translateY(-50%);
      width: 80%;
      min-height: 3em;
      font-size: 1em;
      color: black;
      z-index: 1;
      pointer-events: none;
      margin-top: 0;
    }

    /* å¯¹è¯æ¡†å›¾ç‰‡ */
    .dialog-img {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      max-width: 100%;
      height: auto;
      z-index: -1;
      object-fit: contain;
    }

    /* æ§åˆ¶æŒ‰é’®å›¾ç‰‡å®¹å™¨ */
    .control-images {
      position: absolute;
      bottom: 25px;
      right: 30px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      z-index: 1;
    }

    /* æ§åˆ¶æŒ‰é’®å›¾ç‰‡ */
    .control-img {
      width: 89px;
      height: 26.4px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      z-index: 2;
      object-fit: contain;
    }

    .control-img:hover {
      transform: scale(1.1);
      filter: brightness(1.2);
    }

    /* ä¾§è¾¹æ  */
    #sidebar {
      position: fixed;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      width: 220px;
      height: 100%;
      background: rgba(30, 30, 30, 0.5);
      backdrop-filter: blur(12px);
      color: #fff;
      padding: 1em;
      transition: transform 0.3s ease;
      z-index: 100;
      border-right: 1px solid rgba(255,255,255,0.1);
    }

    #sidebar.show {
      transform: translateX(0);
    }

    /* ä¾§è¾¹æ æŒ‰é’®ç»Ÿä¸€æ ·å¼ */
    #sidebar button {
      width: 100%;
      padding: 0.5em;
      margin: 0;
      border: none;
      border-radius: 5px;
      background: pink;
      color: #000;
      font-size: 1em;
      cursor: pointer;
    }

    /* è®©ä¸‰ä¸ªæŒ‰é’®çºµå‘æ’åˆ—ï¼Œé—´è·å‡åŒ€ */
    #sidebar .sidebar-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }

    /* ä¾§è¾¹æ è§¦å‘æŒ‰é’® */
    #sidebar-toggle {
      position: fixed;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      width: 30px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      color: #000;
      font-size: 24px;
      line-height: 60px;
      text-align: center;
      cursor: pointer;
      border-top-right-radius: 5px;
      border-bottom-right-radius: 5px;
      z-index: 101;
      user-select: none;
      transition: background 0.2s;
    }

    #sidebar-toggle:hover {
      background: rgba(255, 255, 255, 0.4);
    }

    /* éŸ³é‡æ§åˆ¶ */
    .volume-control {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .volume-control input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: #555;
      border-radius: 3px;
      outline: none;
      cursor: pointer;
    }

    /* æ»‘å— */
    .volume-control input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: #ffcc00;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #000;
      transition: background 0.2s;
    }

    .volume-control input[type="range"]::-webkit-slider-thumb:hover {
      background: #ffd633;
    }

    /* Firefox */
    .volume-control input[type="range"]::-moz-range-thumb {
      width: 14px;
      height: 14px;
      background: #ffcc00;
      border-radius: 50%;
      border: 2px solid #000;
      cursor: pointer;
    }

    /* é€‰æ‹©æ¡† */
    #choice-container {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 40%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      gap: 1em;
      z-index: 200;
      background: none;
      backdrop-filter: none;
      padding: 0;
      border-radius: 0;
    }

    .choice-btn {
      padding: 0.8em 1.2em;
      border: none;
      border-radius: 8px;
      width: 90%;
      background: pink;
      color: #000;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .choice-btn:hover {
      background: rgba(255, 192, 203, 0.8);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* ç‰¹æ®Šç‰©å“æ ·å¼ */
    #special-item {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 150;
      cursor: pointer;
      animation: shake 2s infinite;
    }

    @keyframes shake {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(-2deg); }
      50% { transform: rotate(2deg); }
      75% { transform: rotate(-2deg); }
      100% { transform: rotate(0deg); }
    }

    #special-item img {
      width: 60px;
      height: 60px;
    }

    /* è§’è‰²å¤´åƒå®¹å™¨ */
    .character-avatar {
      right: 10%;
      z-index: 10;
      width: 300px;
      height: 300px;
      display: flex;
      position: absolute;
      bottom: 20%;
      max-height: 140%;
      mask-image: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 1) 70%,  /* 70% ä»¥ä¸‹å®Œå…¨ä¸é€æ˜ */
      rgba(0, 0, 0, 0) 100%  /* 100% ä»¥ä¸‹å®Œå…¨é€æ˜ */
    );
    }

    /* è§’è‰²å¤´åƒå›¾ç‰‡ */
    #character-avatar {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    /* éšè—ç±» */
    .hidden {
      display: none !important;
    }

    /* å·²è‡ªåŠ¨å­˜æ¡£çš„æ˜¾ç¤º */
    #auto-save-notice {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 0.5em 1em;
      border-radius: 8px;
      font-size: 0.9em;
      z-index: 300;
      opacity: 0;
      transition: opacity 0.5s;
    }

    #auto-save-notice.show {
      opacity: 1;
    }

    /* å¥½æ„Ÿåº¦æ¡ */
    .affection-container {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 50;
    }

    .affection-bar {
      position: relative;
      width: 200px;
      height: 30px;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }

    .affection-bg {
      position: absolute;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      opacity: 0.8;
    }

    .affection-fill {
      position: absolute;
      height: 100%;
      background: rgba(255, 192, 203, 0.7);
      transition: width 0.3s ease;
    }

    .affection-text {
      position: absolute;
      width: 100%;
      text-align: center;
      line-height: 30px;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
      font-size: 0.9em;
    }

    /* æ‰‹æœºå›¾åƒæ ·å¼ */
    #phone-image {
      position: fixed;
      top: 100px;
      right: 20px;
      z-index: 100;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    #phone-image:hover {
      transform: scale(1.05);
    }

    /* æ‰‹æœºèŠå¤©ç•Œé¢ */
    #phone-chat-interface {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      width: 320px;
      height: 600px;
      background: #f5f5f5;
      border-radius: 30px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow: hidden;
      display: none;
      opacity: 0;
      transition: all 0.3s ease;
    }

    #phone-chat-interface.show {
      display: block;
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    /* æ‰‹æœºçŠ¶æ€æ  */
    .phone-status-bar {
      height: 25px;
      background: #000;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 15px;
      font-size: 12px;
    }

    /* æ‰‹æœºèŠå¤©æ ‡é¢˜æ  */
    .chat-header {
      height: 50px;
      background: #ededed;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 15px;
      border-bottom: 1px solid #d9d9d9;
    }

    .chat-back-btn {
      font-size: 18px;
      cursor: pointer;
    }

    .chat-title {
      font-weight: bold;
    }

    .chat-more-btn {
      font-size: 18px;
      cursor: pointer;
    }

    /* èŠå¤©å†…å®¹åŒºåŸŸ */
    .chat-messages {
      height: calc(100% - 135px);
      overflow-y: auto;
      padding: 15px;
      background: #f5f5f5;
    }

    /* æ¶ˆæ¯æ ·å¼ */
    .message {
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
    }

    .message.received {
      align-items: flex-start;
    }

    .message.sent {
      align-items: flex-end;
    }

    .message-content {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 18px;
      margin-top: 5px;
      position: relative;
    }

    .message.received .message-content {
      background: white;
      border-top-left-radius: 4px;
    }

    .message.sent .message-content {
      background: #95ec69;
      border-top-right-radius: 4px;
    }

    .message-time {
      font-size: 12px;
      color: #888;
      margin-top: 3px;
    }

    /* èŠå¤©è¾“å…¥åŒºåŸŸ */
    .chat-input-area {
      height: 60px;
      background: #f5f5f5;
      display: flex;
      align-items: center;
      padding: 0 15px;
      border-top: 1px solid #d9d9d9;
    }

    .chat-input {
      flex: 1;
      height: 36px;
      border: 1px solid #d9d9d9;
      border-radius: 18px;
      padding: 0 15px;
      margin-right: 10px;
      outline: none;
    }

    .chat-send-btn {
      width: 36px;
      height: 36px;
      background: #07c160;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* å“åº”å¼ */
    @media (max-width: 600px) {
      .dialog-box {
        width: 95%;
        padding: 0.8em;
      }

      .dialog-text {
        font-size: 1em;
      }

      .control-img {
        width: 30px;
        height: 30px;
      }

      #sidebar {
        width: 70%;
      }

      #sidebar-toggle {
        width: 25px;
        height: 50px;
        font-size: 20px;
      }

      .affection-container {
        top: 10px;
        right: 10px;
      }

      .affection-bar {
        width: 150px;
        height: 25px;
      }

      .affection-text {
        line-height: 25px;
        font-size: 0.8em;
      }

      #phone-chat-interface {
        width: 90%;
        height: 80%;
      }
    }
    @keyframes phoneVibrate {
      0% { transform: translateX(0) translateY(0); }
      25% { transform: translateX(-2px) translateY(2px); }
      50% { transform: translateX(2px) translateY(-2px); }
      75% { transform: translateX(-2px) translateY(-2px); }
      100% { transform: translateX(0) translateY(0); }
    }
    
    .phone-vibrating {
      animation: phoneVibrate 0.2s infinite;
    }
    
    .phone-notification {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 20px;
      height: 20px;
      background-color: #ff4757;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 101;
    }
    @keyframes phoneVibrate {
      0% { transform: translateX(0) translateY(0); }
      25% { transform: translateX(-2px) translateY(2px); }
      50% { transform: translateX(2px) translateY(-2px); }
      75% { transform: translateX(-2px) translateY(-2px); }
      100% { transform: translateX(0) translateY(0); }
    }
    
    .phone-vibrating {
      animation: phoneVibrate 0.2s infinite;
    }
    
    .phone-notification {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 20px;
      height: 20px;
      background-color: #ff4757;
      border-radius: 50%;
      color: white;
      font-size: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 101;
    }
    .phone-background-mode .dialog-box {
  background-color: rgba(0, 0, 0, 0.7);
  border-radius: 10px;
  width: 90%;
  height: auto;
  min-height: 100px;
  padding: 15px;
  z-index: 1001; /* ç¡®ä¿å¯¹è¯æ¡†åœ¨æ‰‹æœºç•Œé¢ä¸Šæ–¹ */
}

.phone-background-mode .dialog-text {
  color: white;
  pointer-events: auto;
}

.phone-background-mode .dialog-img,
.phone-background-mode .control-images,
.phone-background-mode .character-avatar {
  display: none;
}

/* æ‰‹æœºèŠå¤©ç•Œé¢åœ¨å‰§æƒ…æ¨¡å¼ä¸‹çš„æ ·å¼ */
.story-phone-mode #phone-chat-interface {
  z-index: 1000; /* ä½äºå¯¹è¯æ¡† */
}

/* æ™®é€šæ‰‹æœºæ¨¡å¼ä¸‹çš„æ ·å¼ */
.normal-phone-mode #phone-chat-interface {
  z-index: 1001; /* é«˜äºå…¶ä»–å…ƒç´  */
}

.normal-phone-mode .dialog-box {
  display: none; /* éšè—å¯¹è¯æ¡† */
}
  </style>
</head>
<body>
  <!-- å¯¹è¯æ¡† -->
  <div class="dialog-box">
    <div class="character-name">èŠ³ä¹ƒ</div>
    <div class="dialog-text" id="dialog-text"></div>
    <div class="character-avatar">
      <img src="" alt="è§’è‰²å¤´åƒ" id="character-avatar">
    </div>
    <div class="dialog-controls">
      <img src="images/kuang.png" alt="å¯¹è¯æ¡†" class="dialog-img">
      <div class="control-images">
        <img src="images/shangyiju.png" alt="ä¸Šä¸€å¥" id="prev-btn" class="control-img">
        <img src="images/jiasu.png" alt="åŠ é€Ÿ" id="speed-btn" class="control-img">
        <img src="images/zidong.png" alt="è‡ªåŠ¨æ’­æ”¾" id="auto-btn" class="control-img">
        <img src="images/tiaoguo.png" alt="è·³è¿‡" id="skip-btn" class="control-img">
        <img src="images/xiayiju.png" alt="ä¸‹ä¸€å¥" id="next-btn" class="control-img">
      </div>
    </div>
  </div>

  <!-- å¥½æ„Ÿåº¦æ¡ -->
  <div class="affection-container">
    <div class="affection-bar">
      <div class="affection-bg" style="background-image: url('images/6.png')"></div>
      <div class="affection-fill" data-character="fang" style="width: 50%"></div>
      <div class="affection-text">èŠ³ä¹ƒ: 50%</div>
    </div>
    <div class="affection-bar">
      <div class="affection-bg" style="background-image: url('images/6.png')"></div>
      <div class="affection-fill" data-character="other" style="width: 30%"></div>
      <div class="affection-text">å…¶ä»–: 30%</div>
    </div>
  </div>

  <!-- ä¾§è¾¹æ è§¦å‘æŒ‰é’® -->
  <div id="sidebar-toggle">â–¶</div>

  <!-- ä¾§è¾¹æ  -->
  <div id="sidebar">
    <h3>è®¾ç½®</h3>
    <div class="sidebar-buttons">
      <button id="main-menu-btn">å›åˆ°ä¸»èœå•</button>
      <button id="load-btn">è¯»æ¡£</button>
      <button id="save-btn">å­˜æ¡£</button>
      <button id="music-btn">éŸ³ä¹æš‚åœ</button>
    </div>

    <div class="volume-control">
      <label for="volume-range">éŸ³é‡</label>
      <input type="range" id="volume-range" min="0" max="100" value="50">
    </div>
  </div>

  <!-- é€‰æ‹©ç•Œé¢ -->
  <div id="choice-container" class="hidden">
    <button class="choice-btn" data-choice="A">é€‰é¡¹A</button>
    <button class="choice-btn" data-choice="B">é€‰é¡¹B</button>
    <button class="choice-btn" data-choice="C">é€‰é¡¹C</button>
  </div>
  
  <!-- æ‰‹æœºå›¾åƒ - å¸¸é©»æ˜¾ç¤ºåœ¨å³ä¸Šæ–¹ -->
  <div id="phone-image">
    <img src="../../phone.png" alt="æ‰‹æœº" style="width: 130px; height: 150px;">
  </div>
  
  <!-- æ‰‹æœºèŠå¤©ç•Œé¢ -->
  <div id="phone-chat-interface">
    <div class="phone-status-bar">
      <span>12:30</span>
      <span>ğŸ“¶ 100% ğŸ”‹</span>
    </div>
    <div class="chat-header">
      <div class="chat-back-btn" id="chat-close-btn">â†</div>
      <div class="chat-title">å­¦å§</div>
      <div class="chat-more-btn">â‹¯</div>
    </div>
    <div class="chat-messages" id="chat-messages">
      <!-- èŠå¤©æ¶ˆæ¯å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
    </div>
    <div class="chat-input-area">
      <input type="text" class="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
      <button class="chat-send-btn">â†µ</button>
    </div>
  </div>
  
  <div id="auto-save-notice" class="hidden">å·²å­˜æ¡£</div>

  <script>
    // DOMå…ƒç´ 
    const musicBtn = document.getElementById("music-btn");
    const volumeRange = document.getElementById("volume-range");
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("sidebar-toggle");
    const mainMenuBtn = document.getElementById("main-menu-btn");
    const saveBtn = document.getElementById("save-btn");
    const loadBtn = document.getElementById("load-btn");
    const dialogText = document.getElementById("dialog-text");
    const nameBox = document.querySelector(".character-name");
    const avatarContainer = document.querySelector(".character-avatar");
    const avatarImg = document.getElementById("character-avatar");
    const nextBtn = document.getElementById("next-btn");
    const prevBtn = document.getElementById("prev-btn");
    const speedBtn = document.getElementById("speed-btn");
    const skipBtn = document.getElementById("skip-btn");
    const autoBtn = document.getElementById("auto-btn");
    const choiceContainer = document.getElementById("choice-container");
    const choiceBtns = document.querySelectorAll(".choice-btn");
    const dialogBox = document.querySelector(".dialog-box");
    const specialItem = document.getElementById("special-item");
    const autoSaveNotice = document.getElementById("auto-save-notice");
    const phoneImage = document.getElementById("phone-image");
    const phoneChatInterface = document.getElementById("phone-chat-interface");
    const chatCloseBtn = document.getElementById("chat-close-btn");
    const chatMessages = document.getElementById("chat-messages");
    const chatInput = document.querySelector(".chat-input");
    const chatSendBtn = document.querySelector(".chat-send-btn");

    // çŠ¶æ€å˜é‡
    let index = 0;
    let charIndex = 0;
    let typingSpeed = 50;
    let typingInterval = null;
    let autoPlay = false;
    let autoInterval = null;
    let isFast = false;
    let waitingForItem = false;
    let isSpecialItemClicked = false;
    let hasReceivedFinalMessage = false;
    let waitingForPhoneResponse = false;
    let phoneNotification = null;
    let isPhoneBackgroundMode = false;
    let isWaitingForSend = false;
    let isInStoryMode = true;
    let isStoryPhoneMode = false;
    let hasTriggeredPhoneVibration = false; // æ–°å¢ï¼šæ ‡è®°æ˜¯å¦å·²è§¦å‘æ‰‹æœºéœ‡åŠ¨

    // å¥½æ„Ÿåº¦æ•°æ®
    let affectionData = { fang: 50, other: 30 };

    // åˆå¹¶æ‰€æœ‰å‰§æƒ…å¯¹è¯ - æŒ‰ç…§æ–‡ä»¶å¤¹åç§°é¡ºåºæ’åˆ—
    const dialogues = [
      { name: "æ—ç™½", text: "ä¸€å­¦æœŸçš„å¤§å­¦ç”Ÿæ´»ï¼Œå¦‚åŒè¢«é£å¹æ•£çš„äº‘çƒŸï¼Œåœ¨ä¸çŸ¥ä¸è§‰ä¸­èµ°åˆ°äº†å­¦å§çº¦å®šçš„åˆ†åˆ«æ—¶åˆ»" },
      { name: "æ—ç™½", text: "ä½ çš„æ‰‹æœºå±å¹•æ˜ å‡ºä¸€ç‰‡æ·¡æ·¡çš„ç™½å…‰ï¼Œåå°„åœ¨å¤©èŠ±æ¿ä¸Šï¼Œä¸å‚æ™šçš„æ™šéœäº¤ç»‡åœ¨ä¸€èµ·ã€‚" },
      { name: "æ—ç™½", text: "ä½ å°±è¿™æ ·çœ‹ç€å¤©èŠ±æ¿å‘å‘†ï¼Œæ€ç»ªçº·é£ã€‚" },
      { name: "æ—ç™½", text: "ä½ ä¸€ä¸ªå­¦æœŸå°±è¿™æ ·è¿‡å»äº†ã€‚å¾ˆå¿™ï¼Œå´åˆè¯´ä¸ä¸Šå¿™äº†äº›ä»€ä¹ˆã€‚" },
      { name: "æ—ç™½", text: "ä½ åŠªåŠ›å›æƒ³ï¼Œè¿™ä¸€å­¦æœŸç©¶ç«Ÿæœ‰ä»€ä¹ˆå€¼å¾—ç•™æ‹çš„ç¬é—´ã€‚" },
      { name: "æ—ç™½", text: "é™¤äº†å’Œé’æ¢…çš„æ—¶å…‰ï¼Œä¼¼ä¹å°±åªæœ‰å­¦å§çš„å­˜åœ¨è®©ä½ è®°å¾—ã€‚" },
      { name: "B", text: "å­¦å§å°±è¦èµ°äº†å•Šã€‚" },
      { name: "B", text: "æˆ‘çœŸçš„å¾ˆå–œæ¬¢å­¦å§â€¦â€¦ä½†å¥¹å¯¹æˆ‘ï¼Œå¤§æ¦‚åªæ˜¯æ™®é€šæœ‹å‹çš„æ€åº¦å§ã€‚" },
      { name: "B", text: "è¦åˆ†åˆ«äº†â€¦â€¦æˆ‘è¯¥å‘å¥¹è¡¨ç™½å—ï¼Ÿ" },
      { name: "B", text: "ä¼šä¸ä¼šâ€¦â€¦å­¦å§ä¹Ÿå¯¹æˆ‘æœ‰ä¸€ç‚¹ç‚¹æ„æ€å‘¢ï¼Ÿ" },
      { name: "B", text: "å“ˆå“ˆï¼Œåˆ«å‚»äº†ï¼Œç°å®å“ªæœ‰åŠ¨æ¼«é‡Œé‚£ä¹ˆç¾å¥½çš„åŒå‘å¥”èµ´ã€‚" },
      { name: "B", text: "æˆ‘â€¦â€¦çœŸçš„èˆä¸å¾—å¥¹ã€‚" },
      { name: "B", text: "ä¸è¿‡ï¼Œå°±è¿™æ ·ä¸‹å»ï¼Œä¹Ÿè®¸æŒºå¥½çš„ï¼Œæœ‹å‹ä»¥ä¸Šæ‹äººæœªæ»¡çš„çŠ¶æ€ã€‚" },
      { name: "B", text: "æ˜¯å•Šï¼Œå°±ç®—è¡¨ç™½æˆåŠŸäº†ï¼ŒçœŸçš„åœ¨ä¸€èµ·ï¼Œå¼‚åœ°æ‹ä¹Ÿæ’‘ä¸äº†å¤šä¹…ï¼Œæˆ‘ä»¬ä¹Ÿæ²¡ä»€ä¹ˆæƒ…æ„ŸåŸºç¡€â€¦â€¦"},
      { name: "B", text: "å­¦å§ä»¥åè‚¯å®šä¹Ÿå¾ˆå¿™æ²¡ä»€ä¹ˆç²¾åŠ›è°ˆæ‹çˆ±å§â€¦â€¦"},
      { name: "B", text: "ä½ æƒ³åˆ°äº†ä½ æœ‰å¾ˆå¤šçš„æœ‹å‹ï¼Œé«˜ä¸­æ¯•ä¸šè¡¨ç™½ä¹‹åï¼Œå¤§å­¦å¼‚åœ°æ‹ï¼Œæ²¡è¿‡å¤šä¹…å°±åˆ†æ‰‹äº†ï¼Œååˆ†ç—›è‹¦ã€‚" },
      { name: "B", text: "å¼‚åœ°å¯¹äºæ²¡æœ‰æƒ…æ„ŸåŸºç¡€çš„æƒ…ä¾£æ¥è¯´è¿˜æ˜¯å¤ªéš¾ã€‚" },
      { name: "B", text: "è€Œä¸”å­¦å§å¯¹æˆ‘å¹¶ä¸æ˜¯é‚£ä¹ˆå–œæ¬¢ã€‚" },
      { name: "C", text: "æƒ³åˆ°è¿™äº›ï¼Œä½ çš„å¿ƒé‡Œå·²ç»å¼€å§‹æ‰“é€€å ‚é¼“ã€‚" },
      { name: "C", text: "æ€ç»ªä¹±æˆä¸€é”…ç²¥ï¼ŒçŸ›ç›¾ä¸çŠ¹è±«äº¤ç»‡åœ¨è„‘æµ·é‡Œã€‚" },
      { name: "C", text: "æœ€ç»ˆä½ æƒ³åˆ°ä¸€ä¸ªåŠæ³•ï¼šè¿˜æ˜¯çœ‹å­¦å§çš„ååº”ã€‚" },
      { name: "B", text: "å¦‚æœå¥¹æ¥å‘æˆ‘è¡¨ç™½äº†ï¼Œé‚£æˆ‘å½“ç„¶æ¥å—ã€‚" },
      { name: "B", text: "ä½†æ˜¯å¦‚æœå¥¹æ²¡å‘æˆ‘è¡¨ç™½ï¼Œé‚£ä¹Ÿå°±è¯´æ˜å¥¹å¯¹æˆ‘å¹¶ä¸æ˜¯é‚£ä¹ˆä¸èˆäº†å§ã€‚" },
      { name: "B", text: "é‚£æˆ‘ä¹Ÿå°±ä¸å¿…å»è¡¨ç™½äº†ã€‚" },
      // å¥½æ„Ÿåº¦ä¸è¶³1çš„å‰§æƒ…
      { name: "B", text: "å¯â€¦â€¦è¿™æ ·æˆ‘çœŸçš„ä¸ä¼šåæ‚”å—ï¼Ÿ" },
      { name: "B", text: "äººæ€ä¹ˆä¼šè¿™ä¹ˆçŸ›ç›¾å‘¢â€¦â€¦" },
      // è¿™é‡Œä¿®æ”¹ä¸ºè§¦å‘æ‰‹æœºéœ‡åŠ¨çš„å¯¹è¯
      { name: "C", text: "å¿½ç„¶ï¼Œæ‰‹æœºè½»è½»æŒ¯åŠ¨äº†ä¸€ä¸‹" },
      // è¿™é‡Œç§»é™¤äº†å­¦å§æ¶ˆæ¯çš„ç›´æ¥æ˜¾ç¤ºï¼Œæ”¹ä¸ºé€šè¿‡æ‰‹æœºæŸ¥çœ‹
      { name: "C", text: "ä½ æ‹¿èµ·æ‰‹æœºï¼Œçœ‹åˆ°æ˜¯å­¦å§å‘æ¥çš„æ¶ˆæ¯" },
      { name: "C", text: "ä½ ç›¯ç€å±å¹•ï¼Œå›å¿†ç€ä¸€ä¸ªå­¦æœŸä¸­ä¸å­¦å§å…±åŒåº¦è¿‡çš„ç‚¹æ»´æ—¶å…‰ã€‚" },
      { name: "C", text: "è™½ç„¶çç¢ï¼Œå´ä¹Ÿæ¸©æš–è€Œç¾å¥½ã€‚" },
      { name: "C", text: "ä½ æƒ³åˆ°è¿™äº›ï¼Œè¿…é€Ÿçš„æ‰“å‡ºäº†ä¸€å¥ï¼šå­¦å§æˆ‘è¿˜æœ‰å¾ˆå¤šè¯æƒ³å’Œä½ è¯´" },
      { name: "C", text: "å¯ä½ åˆæƒ³åˆ°äº†è¢«æ‹’ç»ä¹‹åçš„ç§ç§å¯èƒ½ï¼Œåˆæˆ–æ˜¯å¼‚åœ°æ‹çš„å„ç§å¯èƒ½ï¼Œæ…¢æ…¢åœ°å°†é‚£å¥æœªå‘çš„æ¶ˆæ¯åˆ å»äº†" },
      
      // å¥½æ„Ÿåº¦ä¸è¶³2çš„å‰§æƒ…
      { name: "B", text: "å°±è¿™æ ·å§ã€‚ä½œä¸ºæœ‹å‹ï¼Œæˆ‘ä»¥åè¿˜æ˜¯èƒ½è§åˆ°å­¦å§ï¼Œè¿˜æ˜¯èƒ½çœ‹å¥¹çš„æ¼”å‡ºã€‚" },
      { name: "B", text: "å¦‚æœæ…ç ´äº†è¿™ä¸€å±‚çº±çª—ï¼Œå¯èƒ½ä»€ä¹ˆéƒ½ä¸å‰©äº†â€¦â€¦" },
      { name: "B", text: "è¦æ˜¯è¢«æ‹’ç»äº†ï¼Œæˆ‘ä¹Ÿè®¸è¿å‡ºç°åœ¨å¥¹çš„ä¸–ç•Œé‡Œéƒ½ä¸åº”è¯¥äº†å§â€¦â€¦" },
      { name: "B", text: "ä½ åƒæ˜¯ä¸‹å®šäº†æŸç§å†³å¿ƒ" },
      { name: "B", text: "ä½ åœ¨æ‰‹æœºä¸Šæ‰“å‡ºï¼š" },
      { name: "B", text: "æœ€ç»ˆä½ æŒ‰ä¸‹äº†å‘é€é”®" },
      // å¥½æ„Ÿåº¦ä¸è¶³5çš„å‰§æƒ…
      { name: "B", text: "å”‰â€¦â€¦" },
      { name: "B", text: "ç¨å¾®æœ‰äº›éš¾è¿‡ã€‚" },
      { name: "B", text: "å¥½åƒå°˜åŸƒè½å®šäº†ã€‚è™½ç„¶æœ‰äº›é—æ†¾ï¼Œä½†â€¦â€¦ä¹Ÿæœªå¿…ä¸å¥½ã€‚" },
      { name: "B", text: "ä¹Ÿè®¸â€¦â€¦ä¸€è¾ˆå­éƒ½ä¸ä¼šå¿˜è®°å¥¹å§ã€‚" },
      { name: "C", text: "æ€ç»ªæ¸æ¸é£˜è¿œï¼Œä¸–ç•Œçš„è‰²å½©æ…¢æ…¢è¤ªå»ï¼Œå±å¹•çš„å…‰æ˜ ç…§ä¸‹ï¼Œä¸€åˆ‡éƒ½åŒ–ä½œè‹ç™½ã€‚" },
      { name: "BE", text: "æ­¤æƒ…å¯å¾…æˆè¿½å¿†ï¼Œåªæ˜¯å½“æ—¶å·²æƒ˜ç„¶ã€‚" },
    ];

    // èŠå¤©æ¶ˆæ¯æ•°æ® - åˆå§‹åªæœ‰å‰é¢çš„èŠå¤©è®°å½•
    let chatData = [
      { sender: "received", text: "å­¦å¼Ÿå›ï¼Œæœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ", time: "10:30" },
      { sender: "sent", text: "è¿˜ä¸é”™ï¼Œå°±æ˜¯æœ‰ç‚¹å¿™ã€‚å­¦å§å‘¢ï¼Ÿ", time: "10:32" },
      { sender: "received", text: "æˆ‘ä¹Ÿè¿˜å¥½ï¼Œæœ€è¿‘åœ¨å‡†å¤‡æ¯•ä¸šæ¼”å‡º", time: "10:35" },
      { sender: "received", text: "ä½ ä¼šæ¥çœ‹å—ï¼Ÿ", time: "10:35" },
      { sender: "sent", text: "å½“ç„¶ä¼šï¼æˆ‘ä¸€å®šä¼šå»çš„ï¼", time: "10:36" },
      { sender: "received", text: "å¤ªå¥½äº†ï¼æˆ‘ä¼šç»™ä½ ç•™æœ€å¥½çš„ä½ç½® (ï¼¾â–½ï¼¾)", time: "10:37" },
      { sender: "received", text: "è¯´èµ·æ¥ï¼Œæ—¶é—´è¿‡å¾—çœŸå¿«å‘¢", time: "10:38" },
      { sender: "received", text: "æ„Ÿè§‰æ˜¨å¤©æ‰åˆšè®¤è¯†ä½ ", time: "10:38" },
      { sender: "sent", text: "æ˜¯å•Šï¼Œä¸€å­¦æœŸå°±è¿™ä¹ˆè¿‡å»äº†", time: "10:40" },
      { sender: "sent", text: "å’Œå­¦å§åœ¨ä¸€èµ·çš„æ—¶å…‰çœŸçš„å¾ˆå¼€å¿ƒ", time: "10:40" },
      { sender: "received", text: "æˆ‘ä¹Ÿæ˜¯å“¦ï¼Œå’Œä½ åœ¨ä¸€èµ·å¾ˆæ„‰å¿«", time: "10:42" },
      { sender: "received", text: "å¯æƒœæˆ‘é©¬ä¸Šå°±è¦æ¯•ä¸šäº†...", time: "10:42" },
      { sender: "sent", text: "å—¯...", time: "10:45" }
    ];

    // å­¦å§å¯èƒ½çš„å›å¤
    const seniorReplies = [
      "æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æœ‰ç‚¹å¿™ï¼Œæ™šç‚¹å›å¤ä½ ",
      "å¥½çš„ï¼Œæˆ‘çŸ¥é“äº†",
      "è°¢è°¢ä½ çš„å…³å¿ƒ",
      "æˆ‘ä¼šæƒ³ä½ çš„",
      "ä¿æŒè”ç³»å“¦",
      "æ¯•ä¸šæ¼”å‡ºè®°å¾—æ¥çœ‹å“¦",
      "ä»¥åå¸¸è”ç³»",
      "ä½ ä¹Ÿè¦å¥½å¥½ç…§é¡¾è‡ªå·±",
      "å¤§å­¦æ—¶å…‰çœŸçš„å¾ˆç¾å¥½å‘¢",
      "å¸Œæœ›ä»¥åè¿˜èƒ½è§é¢"
    ];

    // åˆå§‹åŒ–å‡½æ•°
    function init() {
      document.body.classList.add("fade-in");
      
      // åˆå§‹åŒ–å¥½æ„Ÿåº¦ç³»ç»Ÿ
      initAffection();
      
      // æ˜¾ç¤ºåˆå§‹å¯¹è¯
      showDialogue(0);
      
      // åˆå§‹åŒ–æ‰‹æœºèŠå¤©ç•Œé¢
      initPhoneChat();
      
      // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
      initEventListeners();
    }

    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
    function initEventListeners() {
      // æ·»åŠ ç©ºæ ¼é”®å’Œé¼ æ ‡ç‚¹å‡»å®ç°ä¸‹ä¸€å¥çš„åŠŸèƒ½
      document.addEventListener("keydown", (e) => {
        if (e.code === "Space") {
          e.preventDefault();
          triggerNextDialogue();
        }
      });

      // ä¿®æ”¹ç‚¹å‡»äº‹ä»¶å¤„ç†ï¼Œæ’é™¤æ‰‹æœºå›¾åƒå’ŒèŠå¤©ç•Œé¢
      document.addEventListener("click", (e) => {
        const isPhoneImage = e.target.closest("#phone-image");
        // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦åœ¨èŠå¤©ç•Œé¢å†…
        const isInChatInterface = e.target.closest("#phone-chat-interface");
        
        // å¦‚æœæ˜¯åœ¨å‰§æƒ…æ¨¡å¼ä¸‹ç‚¹å‡»äº†æ‰‹æœºç•Œé¢ï¼Œæ¨è¿›å‰§æƒ…
        if (isInStoryMode && isInChatInterface && !e.target.closest(".chat-input-area")) {
          triggerNextDialogue();
          return;
        }
        
        // å¦‚æœèŠå¤©ç•Œé¢æ˜¯æ‰“å¼€çš„ï¼Œé˜»æ­¢ç‚¹å‡»æ¨è¿›å‰§æƒ…
        if (phoneChatInterface.classList.contains("show")) {
          return;
        }
        
        // å¦‚æœæ˜¯ç­‰å¾…æ‰‹æœºå“åº”çš„çŠ¶æ€ï¼Œåªæœ‰ç‚¹å‡»æ‰‹æœºæ‰èƒ½ç»§ç»­
        if (waitingForPhoneResponse) {
          if (isPhoneImage) {
            handlePhoneResponse();
          }
          return;
        }
        
        if (!isPhoneImage && 
            !isInChatInterface &&
            !e.target.closest("button") && 
            !e.target.closest(".control-img") && 
            !e.target.closest("#sidebar") && 
            !e.target.closest("#sidebar-toggle") &&
            !e.target.closest("#special-item")) {
          triggerNextDialogue();
        }
      });

      // ä¾§è¾¹æ åˆ‡æ¢
      if (toggleBtn) {
        toggleBtn.addEventListener("click", () => {
          sidebar.classList.toggle("show");
          toggleBtn.textContent = sidebar.classList.contains("show") ? "â—€" : "â–¶";
        });
      }

      // éŸ³ä¹æŒ‰é’®
      if (musicBtn) {
        musicBtn.addEventListener("click", () => {
          // éŸ³ä¹æ§åˆ¶é€»è¾‘
          if (musicBtn.textContent === "éŸ³ä¹æš‚åœ") {
            musicBtn.textContent = "éŸ³ä¹æ’­æ”¾";
          } else {
            musicBtn.textContent = "éŸ³ä¹æš‚åœ";
          }
        });
      }

      // éŸ³é‡æ§åˆ¶
      if (volumeRange) {
        volumeRange.addEventListener("input", () => {
          // éŸ³é‡æ§åˆ¶é€»è¾‘
        });
      }

      // å›åˆ°ä¸»èœå•
      if (mainMenuBtn) {
        mainMenuBtn.addEventListener("click", () => {
          document.body.classList.add("fade-out");
          setTimeout(() => {
            alert("è¿”å›ä¸»èœå•");
            // å®é™…é¡¹ç›®ä¸­è¿™é‡Œåº”è¯¥æ˜¯è·³è½¬åˆ°ä¸»èœå•é¡µé¢
          }, 1000);
        });
      }

      // å­˜æ¡£
      if (saveBtn) {
        saveBtn.addEventListener("click", () => {
          const saveData = {
            index: index,
            affectionData: affectionData
          };
          localStorage.setItem("gameSave", JSON.stringify(saveData));
          
          // æ˜¾ç¤ºå­˜æ¡£æç¤º
          if (autoSaveNotice) {
            autoSaveNotice.classList.add("show");
            setTimeout(() => {
              autoSaveNotice.classList.remove("show");
            }, 2000);
          }
        });
      }

      // è¯»æ¡£
      if (loadBtn) {
        loadBtn.addEventListener("click", () => {
          const saveData = JSON.parse(localStorage.getItem("gameSave"));
          if (saveData) {
            index = saveData.index;
            affectionData = saveData.affectionData;
            updateAffectionBars();
            showDialogue(index);
          } else {
            alert("æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£");
          }
        });
      }

      // ä¸‹ä¸€å¥æŒ‰é’®
      if (nextBtn) {
        nextBtn.addEventListener("click", triggerNextDialogue);
      }

      // ä¸Šä¸€å¥æŒ‰é’®
      if (prevBtn) {
        prevBtn.addEventListener("click", () => {
          if (index > 0) {
            index--;
            showDialogue(index);
          }
        });
      }

      // åŠ é€ŸæŒ‰é’®
      if (speedBtn) {
        speedBtn.addEventListener("click", () => {
          isFast = !isFast;
          if (isFast) {
            typingSpeed = 10;
            speedBtn.style.filter = "brightness(1.5)";
          } else {
            typingSpeed = 50;
            speedBtn.style.filter = "none";
          }
        });
      }

      // è·³è¿‡æŒ‰é’®
      if (skipBtn) {
        skipBtn.addEventListener("click", () => {
          // è·³è¿‡é€»è¾‘
          index = dialogues.length - 1;
          showDialogue(index);
        });
      }

      // è‡ªåŠ¨æ’­æ”¾æŒ‰é’®
      if (autoBtn) {
        autoBtn.addEventListener("click", () => {
          autoPlay = !autoPlay;
          if (autoPlay) {
            autoBtn.style.filter = "brightness(1.5)";
            startAutoPlay();
          } else {
            autoBtn.style.filter = "none";
            stopAutoPlay();
          }
        });
      }

      // é€‰æ‹©æŒ‰é’®
      if (choiceBtns) {
        choiceBtns.forEach(btn => {
          btn.addEventListener("click", () => {
            const choice = btn.getAttribute("data-choice");
            handleChoice(choice);
          });
        });
      }

      // æ‰‹æœºå›¾åƒç‚¹å‡»äº‹ä»¶
      if (phoneImage) {
        phoneImage.addEventListener("click", () => {
          // å¦‚æœæ˜¯åœ¨ç­‰å¾…æ‰‹æœºå“åº”çš„çŠ¶æ€
          if (waitingForPhoneResponse) {
            handlePhoneResponse();
            return;
          }
          
          // æ­£å¸¸æ‰“å¼€æ‰‹æœºèŠå¤©ç•Œé¢
          openPhoneChat();
        });
      }

      // èŠå¤©å…³é—­æŒ‰é’®
      if (chatCloseBtn) {
        chatCloseBtn.addEventListener("click", () => {
          closePhoneChat();
        });
      }

      // èŠå¤©å‘é€æŒ‰é’®
      if (chatSendBtn) {
        chatSendBtn.addEventListener("click", () => {
          sendMessage();
        });
      }

      // èŠå¤©è¾“å…¥æ¡†å›è½¦å‘é€
      if (chatInput) {
        chatInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            sendMessage();
          }
        });
      }
    }

    // æ˜¾ç¤ºå¯¹è¯
    function showDialogue(idx) {
      if (idx >= dialogues.length) {
        return;
      }

      const dialogue = dialogues[idx];
      
      // æ¸…é™¤ä¹‹å‰çš„æ‰“å­—æ•ˆæœ
      if (typingInterval) {
        clearInterval(typingInterval);
      }
      
      // è®¾ç½®è§’è‰²å
      if (nameBox) {
        switch(dialogue.name) {
          case "æ—ç™½":
            nameBox.textContent = "";
            break;
          case "B":
            nameBox.textContent = "æˆ‘";
            break;
          case "C":
            nameBox.textContent = "";
            break;
          case "BE":
            nameBox.textContent = "";
            break;
          case "A":
            nameBox.textContent = "å­¦å§";
            break;
          default:
            nameBox.textContent = dialogue.name;
        }
      }
      
      // è®¾ç½®è§’è‰²å¤´åƒ
      if (avatarImg) {
        switch(dialogue.name) {
          case "æ—ç™½":
          case "C":
          case "BE":
            avatarContainer.style.display = "none";
            break;
          case "B":
            avatarImg.src = "images/ç”·ä¸».png";
            avatarContainer.style.display = "flex";
            break;
          case "A":
            avatarImg.src = "images/å­¦å§.png";
            avatarContainer.style.display = "flex";
            break;
          default:
            avatarContainer.style.display = "none";
        }
      }
      
      // æ‰“å­—æ•ˆæœ
      charIndex = 0;
      if (dialogText) {
        dialogText.textContent = "";
        
        typingInterval = setInterval(() => {
          if (charIndex < dialogue.text.length) {
            dialogText.textContent += dialogue.text.charAt(charIndex);
            charIndex++;
          } else {
            clearInterval(typingInterval);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯è§¦å‘æ‰‹æœºéœ‡åŠ¨çš„å¯¹è¯
            if (dialogue.text.includes("å¿½ç„¶ï¼Œæ‰‹æœºè½»è½»æŒ¯åŠ¨äº†ä¸€ä¸‹") && !hasTriggeredPhoneVibration) {
              triggerPhoneVibration();
              hasTriggeredPhoneVibration = true;
            }
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºé€‰æ‹©
            if (dialogue.choices) {
              showChoices(dialogue.choices);
            }
            
            // è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€å¥
            if (autoPlay) {
              startAutoPlay();
            }
          }
        }, typingSpeed);
      }
    }

    // è§¦å‘ä¸‹ä¸€å¥å¯¹è¯
    function triggerNextDialogue() {
      // å¦‚æœæ­£åœ¨æ‰“å­—ï¼Œç›´æ¥å®Œæˆæ‰“å­—
      if (charIndex < dialogues[index].text.length) {
        clearInterval(typingInterval);
        dialogText.textContent = dialogues[index].text;
        charIndex = dialogues[index].text.length;
        return;
      }
      
      // åœæ­¢è‡ªåŠ¨æ’­æ”¾
      stopAutoPlay();
      
      // å¦‚æœæœ‰é€‰æ‹©ç•Œé¢ï¼Œä¸æ¨è¿›å¯¹è¯
      if (choiceContainer && !choiceContainer.classList.contains("hidden")) {
        return;
      }
      
      // å¦‚æœæ˜¯ç­‰å¾…æ‰‹æœºå“åº”çš„çŠ¶æ€ï¼Œä¸æ¨è¿›å¯¹è¯
      if (waitingForPhoneResponse) {
        return;
      }
      
      // æ¨è¿›åˆ°ä¸‹ä¸€å¥å¯¹è¯
      index++;
      if (index < dialogues.length) {
        showDialogue(index);
        
        // è‡ªåŠ¨å­˜æ¡£
        const saveData = {
          index: index,
          affectionData: affectionData
        };
        localStorage.setItem("gameSave", JSON.stringify(saveData));
      } else {
        // æ¸¸æˆç»“æŸ
        document.body.classList.add("fade-out");
        setTimeout(() => {
          alert("æ¸¸æˆç»“æŸ");
          // å®é™…é¡¹ç›®ä¸­è¿™é‡Œåº”è¯¥æ˜¯è·³è½¬åˆ°ç»“æŸé¡µé¢æˆ–ä¸»èœå•
        }, 1000);
      }
    }

    // å¼€å§‹è‡ªåŠ¨æ’­æ”¾
    function startAutoPlay() {
      if (autoInterval) {
        clearInterval(autoInterval);
      }
      
      autoInterval = setInterval(() => {
        triggerNextDialogue();
      }, 3000);
    }

    // åœæ­¢è‡ªåŠ¨æ’­æ”¾
    function stopAutoPlay() {
      if (autoInterval) {
        clearInterval(autoInterval);
        autoInterval = null;
      }
    }

    // æ˜¾ç¤ºé€‰æ‹©
    function showChoices(choices) {
      if (choiceContainer && choiceBtns) {
        choiceContainer.classList.remove("hidden");
        
        choiceBtns.forEach((btn, i) => {
          if (i < choices.length) {
            btn.textContent = choices[i].text;
            btn.style.display = "block";
          } else {
            btn.style.display = "none";
          }
        });
      }
    }

    // å¤„ç†é€‰æ‹©
    function handleChoice(choice) {
      if (choiceContainer) {
        choiceContainer.classList.add("hidden");
      }
      
      // æ ¹æ®é€‰æ‹©å¢åŠ å¥½æ„Ÿåº¦
      const selectedChoice = dialogues[index].choices.find(c => c.key === choice);
      if (selectedChoice && selectedChoice.affection) {
        for (const [character, value] of Object.entries(selectedChoice.affection)) {
          affectionData[character] += value;
          if (affectionData[character] > 100) affectionData[character] = 100;
          if (affectionData[character] < 0) affectionData[character] = 0;
        }
        updateAffectionBars();
      }
      
      // æ¨è¿›å¯¹è¯
      triggerNextDialogue();
    }

    // åˆå§‹åŒ–å¥½æ„Ÿåº¦ç³»ç»Ÿ
    function initAffection() {
      updateAffectionBars();
    }

    // æ›´æ–°å¥½æ„Ÿåº¦æ¡
    function updateAffectionBars() {
      const affectionBars = document.querySelectorAll(".affection-fill");
      const affectionTexts = document.querySelectorAll(".affection-text");
      
      affectionBars.forEach(bar => {
        const character = bar.getAttribute("data-character");
        bar.style.width = `${affectionData[character]}%`;
      });
      
      affectionTexts.forEach(text => {
        if (text.textContent.includes("èŠ³ä¹ƒ")) {
          text.textContent = `èŠ³ä¹ƒ: ${affectionData.fang}%`;
        } else if (text.textContent.includes("å…¶ä»–")) {
          text.textContent = `å…¶ä»–: ${affectionData.other}%`;
        }
      });
    }

    // åˆå§‹åŒ–æ‰‹æœºèŠå¤©ç•Œé¢
    function initPhoneChat() {
      // æ¸…ç©ºèŠå¤©æ¶ˆæ¯
      chatMessages.innerHTML = "";
      
      // æ·»åŠ åˆå§‹èŠå¤©è®°å½•
      chatData.forEach(msg => {
        addMessageToChat(msg.sender, msg.text, msg.time);
      });
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
    function addMessageToChat(sender, text, time) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${sender}`;
      
      const messageContent = document.createElement("div");
      messageContent.className = "message-content";
      messageContent.textContent = text;
      
      const messageTime = document.createElement("div");
      messageTime.className = "message-time";
      messageTime.textContent = time;
      
      messageDiv.appendChild(messageContent);
      messageDiv.appendChild(messageTime);
      
      chatMessages.appendChild(messageDiv);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // æ‰“å¼€æ‰‹æœºèŠå¤©ç•Œé¢
    function openPhoneChat() {
      phoneChatInterface.classList.add("show");
      isInStoryMode = false;
      document.body.classList.add("normal-phone-mode");
      
      // å¦‚æœæœ‰é€šçŸ¥ï¼Œç§»é™¤å®ƒ
      if (phoneNotification) {
        phoneNotification.remove();
        phoneNotification = null;
      }
    }

    // å…³é—­æ‰‹æœºèŠå¤©ç•Œé¢
    function closePhoneChat() {
      phoneChatInterface.classList.remove("show");
      isInStoryMode = true;
      document.body.classList.remove("normal-phone-mode");
    }

    // å‘é€æ¶ˆæ¯
    function sendMessage() {
      const message = chatInput.value.trim();
      if (message === "") return;
      
      // è·å–å½“å‰æ—¶é—´
      const now = new Date();
      const time = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
      
      // æ·»åŠ å‘é€çš„æ¶ˆæ¯
      addMessageToChat("sent", message, time);
      
      // æ¸…ç©ºè¾“å…¥æ¡†
      chatInput.value = "";
      
      // å¦‚æœæ˜¯ç­‰å¾…å‘é€çš„çŠ¶æ€ï¼Œæ¨è¿›å‰§æƒ…
      if (isWaitingForSend) {
        isWaitingForSend = false;
        setTimeout(() => {
          closePhoneChat();
          triggerNextDialogue();
        }, 1000);
      }
      
      // éšæœºå›å¤
      setTimeout(() => {
        const randomReply = seniorReplies[Math.floor(Math.random() * seniorReplies.length)];
        addMessageToChat("received", randomReply, `${now.getHours()}:${(now.getMinutes() + 1).toString().padStart(2, '0')}`);
      }, 2000);
    }

    // è§¦å‘æ‰‹æœºéœ‡åŠ¨æ•ˆæœ
    function triggerPhoneVibration() {
      // æ·»åŠ éœ‡åŠ¨åŠ¨ç”»ç±»
      phoneImage.classList.add("phone-vibrating");
      
      // æ·»åŠ é€šçŸ¥çº¢ç‚¹
      phoneNotification = document.createElement("div");
      phoneNotification.className = "phone-notification";
      phoneNotification.textContent = "1";
      phoneImage.appendChild(phoneNotification);
      
      // è®¾ç½®ç­‰å¾…æ‰‹æœºå“åº”çš„çŠ¶æ€
      waitingForPhoneResponse = true;
      
      // 3ç§’ååœæ­¢éœ‡åŠ¨
      setTimeout(() => {
        phoneImage.classList.remove("phone-vibrating");
      }, 3000);
    }

    // å¤„ç†æ‰‹æœºå“åº”
    function handlePhoneResponse() {
      // ç§»é™¤é€šçŸ¥
      if (phoneNotification) {
        phoneNotification.remove();
        phoneNotification = null;
      }
      
      // æ‰“å¼€æ‰‹æœºèŠå¤©ç•Œé¢
      openPhoneChat();
      
      // æ·»åŠ å­¦å§çš„æ¶ˆæ¯
      const now = new Date();
      const time = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
      addMessageToChat("received", "â€œå†è§å•¦ï¼Œå­¦å¼Ÿå›~ æˆ‘å·²ç»åœ¨å»æœºåœºçš„è½¦ä¸Šå’¯~ ä»¥åæœ‰æ—¶é—´å¯ä»¥æ¥çœ‹æˆ‘çš„æ¼”å‡ºå“¦ï¼Œæˆ‘ä¼šä¸ºä½ ç•™ç‰¹ç­‰å¸­çš„ (ï¼¾â–½ï¼¾) â€", time);
      
      // è®¾ç½®ç­‰å¾…å‘é€çš„çŠ¶æ€
      isWaitingForSend = true;
      
      // æ›´æ–°çŠ¶æ€
      waitingForPhoneResponse = false;
    }

    // åˆå§‹åŒ–
    window.addEventListener("load", init);
  </script>
</body>
</html>